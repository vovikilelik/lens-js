<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
	<head>
		<title>TODO supply a title</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body>
		<div>TODO write content</div>
		<script type="module">
			import { Lens } from '../src/lens-js.js';
            import { getConsistsCallback, getDebounceCallback, getMapper } from '../src/lens-utils.js';
			
			const store = { lens: { m: { x: 1, y: 1, z: { c: 1 }} } };

			const lens = new Lens(
				() => store.lens,
				(value) => {
					console.log('lens setter');
					store.lens = value;
				}
			);

//			lens.attach(e => console.log('@root', e.current, e.diffs));
			lens.go('m').attach(e => console.log('m', e.current, e.diffs));

			const f = getMapper(
				v => v,
				v => (v + 1)
			);
			
			class XLens extends Lens {
				constructor(...args) {
					super(...args);
				}
				
				get qwe() {
					return this.go('qwe').get();
				}
				
				set qwe(v) {
					this.go('qwe').set(v, () => console.log('XLens set'));
				}
			}
			
			const xf = (core) => (key, p) => {
				const l = core(key, p);
				return new XLens(
					() => l.get(),
					(v, e) => {
						console.log('XLens setter');
						l.set(v, e);
					},
					l
				);
			}
			
			const xm = (core) => (key, p) => {
				return { random: 'object' };
			}
			
			console.log('----go----');
			
			const x = lens.go('any', xf);
			const y = lens.go('any');
			
			const z = lens.go('mapper', f);
			
			const r = lens.go('random', xm);
			
			x.attach(e => console.log('@x', e.current, e.diffs));
			x.go('qwe').attach(e => console.log('@qwe', e.current, e.diffs));
			
			x.qwe = '123';
			x.qwe = '1234';
			
			z.attach(e => console.log('@z', e.current, e.diffs));
			
			z.set('one');
			z.set('two');
			
			console.log(x.get());
			console.log(lens.get());
			
			console.log(r);
			
			let dcc = 0;
			lens.attach(getDebounceCallback(() => {
				console.log('dcc', dcc++, lens.go('debounce').get());
			}));
			for (let i = 0; i < 1000; i++) {
				lens.go('debounce').set(i);
			}
		</script>	
	</body>
</html>
